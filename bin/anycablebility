#!/usr/bin/env ruby

require 'bundler/setup'
require 'optparse'
require 'anycablebility'
require 'anycablebility/cli/app'

options = {}

option_parser = OptionParser.new do |cli|
  cli.banner = <<~BANNER
    Anycablebility â€“ AnyCable websocket server conformance tool.

    Usage: anycablebility [options]

    Options:
  BANNER

  cli.on('--target TARGET_WS_URL', 'URL of target WebSocket server to test.') do |target|
    options[:target] = target
  end

  cli.on('--redis REDIS_URL', 'Redis server URL.') do |redis|
    options[:redis] = redis
  end

  cli.on('--debug', 'Enable debug mode.') do
    options[:debug] = true
  end

  cli.on('-h', '--help', 'Show this message.') do
    puts cli
    exit
  end

  cli.on('--version', 'Print version.') do
    puts Anycablebility::VERSION
    exit
  end
end

begin
  option_parser.parse!
rescue OptionParser::InvalidOption => e
  unknown_option = e.args.first
  puts "This option looks unfamiliar: #{unknown_option}. A typo?"
  puts 'Use `anycablebility --help` to list all available options.'
  exit 1
end

app = Anycablebility::Cli::App.new

begin
  exit_code = app.run(options)
rescue => e
  puts 'Bummer! There is an error:'
  puts e
  exit 1
end

exit exit_code
